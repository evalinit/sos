class SiteOSClient{constructor(e){this.options=e,this.listeners={},this.promises={},this.referrer=null,this.#init()}#init(){var e;this.#setLocation(),this.#setReferrer(),this.options?.trackLocation&&(this.#attachLocationChangeEvents(),e=sessionStorage.getItem("location"),location.href!==e)&&this.#postMessage({name:"SiteOSClientLocationChanged",args:[location.href]}),window.addEventListener("message",e=>this.#onMessage(e))}#setLocation(){sessionStorage.getItem("location")||sessionStorage.setItem("location",location.href)}#setReferrer(){var e=sessionStorage.getItem("referrer"),t=new URL(location.href).searchParams.get("SiteOSReferrer");t&&!e&&sessionStorage.setItem("referrer",t),(t=sessionStorage.getItem("referrer"))&&(this.referrer=t)}#attachLocationChangeEvents(){const{pushState:t,replaceState:s}=history;history.pushState=function(){var e=t.apply(this,arguments);return window.dispatchEvent(new Event("locationchange")),e},history.replaceState=function(){var e=s.apply(this,arguments);return window.dispatchEvent(new Event("locationchange")),e},window.addEventListener("popstate",()=>{window.dispatchEvent(new Event("locationchange"))}),window.addEventListener("locationchange",()=>{this.#postMessage({name:"SiteOSClientLocationChanged",args:[location.href]})})}#onMessage(e){var t,s=new URL(this.referrer).origin;e.origin===s&&({name:s,args:e,promiseID:t}=e.data,t?this.#resolveRequest(t,e):(t=this.listeners[s])&&t(...e))}#postMessage(e){(window.opener||window.parent).postMessage(e,this.referrer)}on(e,t){this.listeners[e]=t}off(e){delete this.listeners[e]}emit(e,...t){this.#postMessage({name:e,args:t})}request(e,...t){const s=crypto.randomUUID();var i=new Promise(e=>{this.promises[s]=e}),e=(t.push(s),{name:e,args:t});return this.#postMessage(e),i}resolve(e,...t){this.#postMessage({promiseID:e,args:t})}#resolveRequest(e,t){var s=this.promises[e];s&&(s(...t),delete this.promises[e])}}class SiteOSController{constructor(e){var t=new URL(e);t.searchParams.set("SiteOSReferrer",location.origin),this.url=t,this.origin=new URL(e).origin,this.listeners={},this.promises={},this.instances=[],this.hiddenContainerID="site-os-hidden-container",this.#init()}#init(){window.addEventListener("message",e=>this.#onMessage(e)),this.#createHiddenContainer()}#onMessage(e){if(e.origin===this.origin){var{name:t,args:s,promiseID:i}=e.data;if(i)this.#resolveRequest(i,s);else{i=this.listeners[t];if(i){for(const o of this.instances){var n="iframe"===o.type&&o.target.contentWindow===e.source,r="tab"===o.type&&o.target===e.source;n&&r&&o}i(...s)}}}}#createHiddenContainer(){var e;document.getElementById(this.hiddenContainerID)||((e=document.createElement("div")).id=this.hiddenContainerID,e.style.display="none",document.body.appendChild(e))}#createInstance(e,t){const i={target:e,type:t,origin:this.origin,listeners:{},on:function(e,t){this.listeners[e]=t},off:function(e){delete this.listeners[e]},emit:function(e,...t){e={name:e,args:t};("iframe"===this.type?this.target.contentWindow:this.target).postMessage(e,this.origin)},resolve:function(e,...t){e={promiseID:e,args:t};("iframe"===this.type?this.target.contentWindow:this.target).postMessage(e,this.origin)}};return i.destroy=()=>{let e;for(var[t,s]of this.instances.entries())if(s===i){e=t;break}i.target.remove(),this.instances.splice(e,1)},this.instances.push(i),i}on(e,t){this.listeners[e]=t}off(e){delete this.listeners[e]}emit(e,...t){var s={name:e,args:t};for(const i of this.instances)("iframe"===i.type?i.target.contentWindow:i.target).postMessage(s,this.origin)}async request(e,...t){const s=crypto.randomUUID();var i=new Promise(e=>{this.promises[s]=e});return t.push(s),this.emit(e,...t),i}resolve(e,...t){var s={promiseID:e,args:t};for(const i of this.instances)("iframe"===i.type?i.target.contentWindow:i.target).postMessage(s,this.origin)}#resolveRequest(e,t){var s=this.promises[e];s&&(s(...t),delete this.promises[e])}async launch(n){return new Promise(e=>{var t=document.createElement("iframe");t.src=this.url,t.allow="geolocation; microphone; camera; display-capture;",t.sandbox="allow-modals allow-forms allow-scripts allow-same-origin allow-popups allow-top-navigation-by-user-activation allow-downloads",t.allowfullscreen="",t.allowpaymentrequest="",t.frameborder="0",t.style.width="100%",t.style.height="100%";const s=this.#createInstance(t,"iframe");t.addEventListener("load",()=>{e(s)});let i;(i=(i=n?"string"==typeof n?document.getElementById(n):n:i)||document.getElementById(this.hiddenContainerID)).appendChild(t)})}launchTab(){var e=window.open(this.url);return this.#createInstance(e,"tab")}}export{SiteOSClient,SiteOSController};