class SiteOSClient{constructor(){this.listeners={},this.promises={},this.queue=[],this.controllerOrigin=null,this.#init()}#init(){window.addEventListener("message",e=>this.#onMessage(e)),window.addEventListener("load",()=>this.#onLoad()),this.#attachLocationChangeEvents(),this.#requestProps()}#onMessage(e){var{name:t,args:s,promiseID:i}=e.data;"SiteOSControllerOrigin"!==t||this.controllerOrigin?e.origin===this.controllerOrigin&&(i?this.#resolveRequest(i,s):(e=this.listeners[t])&&e(...s)):this.#onControllerOrigin(...s)}#onControllerOrigin(e){this.controllerOrigin=e;for(var t of this.queue)this.#postMessage(t);this.queue=[]}#onLoad(){this.#postMessage({name:"SiteOSClientLoaded",args:[]})}#attachLocationChangeEvents(){let{pushState:s,replaceState:i}=history;history.pushState=function(){var e=s.apply(this,arguments),t=new Event("locationchange");return window.dispatchEvent(t),e},history.replaceState=function(){var e=i.apply(this,arguments),t=new Event("locationchange");return window.dispatchEvent(t),e},window.addEventListener("popstate",()=>{var e=new Event("locationchange");window.dispatchEvent(e)}),window.addEventListener("locationchange",()=>{var e={name:"SiteOSClientLocationChanged",args:[location.href]};this.#postMessage(e)})}#createProxy(e){return new Proxy(e,{set:(e,t,s)=>(e[t]=s,this.emit("SiteOSPropsUpdated",e),!0),deleteProperty:(e,t)=>(delete e[t],this.emit("SiteOSPropsUpdated",e),!0)})}#requestProps(){this.propsPromise=new Promise(e=>{this.propsResolve=e}),this.listeners.SiteOSProps=e=>{this.props=this.#createProxy(e),this.propsResolve(e),this.propsPromise=null},this.listeners.SiteOSPropsUpdated=e=>{this.props=this.#createProxy(e),this.propsUpdated?.(e)};this.#postMessage({name:"SiteOSProps"})}#postMessage(e){this.controllerOrigin?(window.opener||window.parent).postMessage(e,this.controllerOrigin):this.queue.push(e)}#resolveRequest(e,t){var s=this.promises[e];s&&(s(...t),delete this.promises[e])}async propsReady(){return this.propsPromise||this.props}on(e,t){this.listeners[e]=t}off(e){delete this.listeners[e]}emit(e,...t){this.#postMessage({name:e,args:t})}request(e,...t){let s=crypto.randomUUID();var i=new Promise(e=>{this.promises[s]=e}),e=(t.push(s),{name:e,args:t});return this.#postMessage(e),i}resolve(e,...t){this.#postMessage({promiseID:e,args:t})}}class SiteOSController{constructor(e,t={}){this.options=t,this.listeners={},this.promises={},this.instances=[],this.hiddenContainerID="site-os-hidden-container",this.#setURL(e),this.#setOrigins(),this.#init()}#setURL(e){e.startsWith("/")&&(e=""+location.origin+e),this.url=e}#setOrigins(){var e=new URL(this.url).origin,t=this.options.allowedOrigins??[];this.origins=new Set([e,...t])}#init(){window.addEventListener("message",e=>this.#onMessage(e)),this.#createHiddenContainer()}#onMessage(e){let t;for(var s of this.instances){var i="iframe"===s.type&&s.target.contentWindow===e.source,r="tab"===s.type&&s.target===e.source;if(i||r){t=s;break}}var o,n,a;this.origins.has(e.origin)&&t&&({name:o,args:n=[],promiseID:a}=e.data,a?this.#resolveRequest(a,n):((0,this.listeners[o])?.(...n,t),(0,t.listeners[o])?.(...n)))}#resolveRequest(e,t){var s=this.promises[e];s&&(s(...t),delete this.promises[e])}#createHiddenContainer(){var e;document.getElementById(this.hiddenContainerID)||((e=document.createElement("div")).id=this.hiddenContainerID,e.style.display="none",document.body.appendChild(e))}#createProxy(e){return new Proxy(e,{set:(e,t,s)=>(e[t]=s,this.emit("SiteOSPropsUpdated",e),!0),deleteProperty:(e,t)=>(delete e[t],this.emit("SiteOSPropsUpdated",e),!0)})}#postToAllOrigins(e,t){for(var s of this.origins)e.postMessage(t,s)}#createInstance(e,t,s){let i={target:e,type:t,props:this.#createProxy(s=s||{}),outerThis:this,listeners:{}};return i.listeners.SiteOSProps=function(){this.emit("SiteOSProps",{...this.props})}.bind(i),i.listeners.SiteOSPropsUpdated=function(e){this.props=this.outerThis.#createProxy(e),this.propsUpdated?.(e)}.bind(i),i.on=function(e,t){this.listeners[e]=t},i.off=function(e){delete this.listeners[e]},i.emit=function(e,...t){e={name:e,args:t};"iframe"===this.type?this.outerThis.#postToAllOrigins(this.target.contentWindow,e):this.outerThis.#postToAllOrigins(this.target,e)},i.toFrame=async function(s){if("iframe"!==this.type)return new Promise(e=>{var t=this.outerThis.#createFrame();t.onload=()=>{e()},this.type="iframe",this.target.close(),this.target=t,this.outerThis.#getContainer(s).appendChild(t)})},i.toTab=async function(){if("tab"!==this.type)return new Promise(e=>{this.on("SiteOSClientLoaded",()=>{this.off("SiteOSClientLoaded"),e()}),this.type="tab",this.target.remove(),this.target=window.open(this.outerThis.url)})},i.request=async function(e,...t){let s=crypto.randomUUID();var i=new Promise(e=>{this.outerThis.promises[s]=e});return t.push(s),this.emit(e,...t),i},i.resolve=function(e,...t){e={promiseID:e,args:t};"iframe"===this.type?this.outerThis.#postToAllOrigins(this.target.contentWindow,e):this.outerThis.#postToAllOrigins(this.target,e)},i.destroy=()=>{let e;for(var[t,s]of this.instances.entries())if(s===i){e=t;break}i.target.remove(),this.instances.splice(e,1)},this.instances.push(i),i}#createFrame(){var e=document.createElement("iframe");return e.src=this.url,e.allow="geolocation; microphone; camera; display-capture;",e.sandbox="allow-modals allow-forms allow-scripts allow-same-origin allow-popups allow-top-navigation-by-user-activation allow-downloads",e.allowfullscreen="",e.allowpaymentrequest="",e.frameborder="0",e.style.width="100%",e.style.height="100%",e}#getContainer(e){let t;return t=(t=e?"string"==typeof e?document.getElementById(e):e:t)||document.getElementById(this.hiddenContainerID)}on(e,t){this.listeners[e]=t}off(e){delete this.listeners[e]}emit(e,...t){var s,i={name:e,args:t};for(s of this.instances)"iframe"===s.type?this.#postToAllOrigins(s.target.contentWindow,i):this.#postToAllOrigins(s.target,i)}async request(e,...t){let s=crypto.randomUUID();var i=new Promise(e=>{this.promises[s]=e});return t.push(s),this.emit(e,...t),i}resolve(e,...t){var s,i={promiseID:e,args:t};for(s of this.instances)"iframe"===s.type?this.#postToAllOrigins(s.target.contentWindow,i):this.#postToAllOrigins(s.target,i)}async launch(i,r){return new Promise(e=>{var t=this.#createFrame();let s=this.#createInstance(t,"iframe",r);t.addEventListener("load",()=>{s.emit("SiteOSControllerOrigin",location.origin),e(s)}),this.#getContainer(i).appendChild(t)})}launchTab(e){var t=window.open(this.url);return this.#createInstance(t,"tab",e)}}export{SiteOSClient,SiteOSController};